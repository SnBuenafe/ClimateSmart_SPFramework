# Multi-model Ensemble {#mme}
We show one of the two ways of dealing with a multi-model ensemble. We've already explored using the mean of the ensemble to calculate for climate metrics. Here, we show the variability amongst models and treat them individually. For this demonstration we use the following parameters:

1. Rate of climate warming

2. "Percentile" approach

```{r include = FALSE}
# Call the climate layers
tos_CanESM5 <- readRDS("../Output/WestPacific_PU_669.9km2_roc_tos_SSP 5-8.5_CanESM5_ensemble.rds")
`tos_CMCC-ESM2` <- readRDS("../Output/WestPacific_PU_669.9km2_roc_tos_SSP 5-8.5_CMCC-ESM2_ensemble.rds")
`tos_GFDL-ESM4` <- readRDS("../Output/WestPacific_PU_669.9km2_roc_tos_SSP 5-8.5_GFDL-ESM4_ensemble.rds")
`tos_IPSL-CM6A-LR` <- readRDS("../Output/WestPacific_PU_669.9km2_roc_tos_SSP 5-8.5_IPSL-CM6A-LR_ensemble.rds")
`tos_NorESM2-MM` <- readRDS("../Output/WestPacific_PU_669.9km2_roc_tos_SSP 5-8.5_NorESM2-MM_ensemble.rds")
```

## Climate-smart spatial design (Rate of Climate Warming; "Percentile" Approach; GCM: CanESM5)
```{r include = FALSE}
ensemble <- list(`tos_CanESM5`, `tos_CMCC-ESM2`, `tos_GFDL-ESM4`, `tos_IPSL-CM6A-LR`, `tos_NorESM2-MM`)
aqua_percentile <- create_PercentileLayer(aqua_sf = aqua_sf, metric_name = "tos", colname = "slpTrends", metric_df = ensemble[[1]], PUs = PUs)

features <- aqua_percentile %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_percentile, tos_CanESM5, cost)
s14 <- readRDS("../Output/solutions/s14-percentile-tos-585-CanESM5-ensemble.rds")
```
```{r}
p14 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.8) %>% # using Effective 40% Protection. Since we only retained planning units that intersect with both biodiversity features and areas >= 50th percentile (0.5), by multiplying this by 0.8 target, we effectively protect only 40%.
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
```{r eval = FALSE}
s14 <- prioritizr::solve(p14)
```
```{r include = FALSE}
s14_plot <- s14 %>% 
  mutate(solution_1 = as.logical(solution_1)) 
(ggSol14 <- fSpatPlan_PlotSolution(s14_plot, PUs, land) + ggtitle("Climate-smart design: Rate of Climate Warming", subtitle = "Percentile, SSP 5-8.5 (GCM: CanESM5)"))
```

## Climate-smart spatial design (Rate of Climate Warming; "Percentile" Approach; GCM: CMCC-ESM2)
```{r include = FALSE}
aqua_percentile <- create_PercentileLayer(aqua_sf = aqua_sf, metric_name = "tos", colname = "slpTrends", metric_df = ensemble[[2]], PUs = PUs)

features <- aqua_percentile %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_percentile, `tos_CMCC-ESM2`, cost)
s15 <- readRDS("../Output/solutions/s15-percentile-tos-585-CMCC-ESM2-ensemble.rds")
```
```{r}
p15 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.8) %>% # using Effective 40% Protection. Since we only retained planning units that intersect with both biodiversity features and areas >= 50th percentile (0.5), by multiplying this by 0.8 target, we effectively protect only 40%.
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
```{r eval = FALSE}
s15 <- prioritizr::solve(p15)
```
```{r include = FALSE}
s15_plot <- s15 %>% 
  mutate(solution_1 = as.logical(solution_1)) 
(ggSol15 <- fSpatPlan_PlotSolution(s15_plot, PUs, land) + ggtitle("Climate-smart design: Rate of Climate Warming", subtitle = "Percentile, SSP 5-8.5 (GCM: CMCC-ESM2)"))
```

## Climate-smart spatial design (Rate of Climate Warming; "Percentile" Approach; GCM: GFDL-ESM4)
```{r include = FALSE}
aqua_percentile <- create_PercentileLayer(aqua_sf = aqua_sf, metric_name = "tos", colname = "slpTrends", metric_df = ensemble[[3]], PUs = PUs)

features <- aqua_percentile %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_percentile, `tos_GFDL-ESM4`, cost)
s16 <- readRDS("../Output/solutions/s15-percentile-tos-585-CMCC-ESM2-ensemble.rds")
```
```{r}
p16 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.8) %>% # using Effective 40% Protection. Since we only retained planning units that intersect with both biodiversity features and areas >= 50th percentile (0.5), by multiplying this by 0.8 target, we effectively protect only 40%.
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
```{r eval = FALSE}
s16 <- prioritizr::solve(p16)
```
```{r include = FALSE}
s16_plot <- s16 %>% 
  mutate(solution_1 = as.logical(solution_1)) 
(ggSol16 <- fSpatPlan_PlotSolution(s16_plot, PUs, land) + ggtitle("Climate-smart design: Rate of Climate Warming", subtitle = "Percentile, SSP 5-8.5 (GCM: GFDL-ESM4)"))
```

## Climate-smart spatial design (Rate of Climate Warming; "Percentile" Approach; GCM: IPSL-CM6A-LR)
```{r include = FALSE}
aqua_percentile <- create_PercentileLayer(aqua_sf = aqua_sf, metric_name = "tos", colname = "slpTrends", metric_df = ensemble[[4]], PUs = PUs)

features <- aqua_percentile %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_percentile, `tos_IPSL-CM6A-LR`, cost)
s17 <- readRDS("../Output/solutions/s17-percentile-tos-585-IPSL-CM6A-LR-ensemble.rds")
```
```{r}
p17 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.8) %>% # using Effective 40% Protection. Since we only retained planning units that intersect with both biodiversity features and areas >= 50th percentile (0.5), by multiplying this by 0.8 target, we effectively protect only 40%.
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
```{r eval = FALSE}
s17 <- prioritizr::solve(p17)
```
```{r include = FALSE}
s17_plot <- s17 %>% 
  mutate(solution_1 = as.logical(solution_1)) 
(ggSol15 <- fSpatPlan_PlotSolution(s17_plot, PUs, land) + ggtitle("Climate-smart design: Rate of Climate Warming", subtitle = "Percentile, SSP 5-8.5 (GCM: IPSL-CM^A-LR)"))
```

## Climate-smart spatial design (Rate of Climate Warming; "Percentile" Approach; GCM: NorESM2-MM)
```{r include = FALSE}
aqua_percentile <- create_PercentileLayer(aqua_sf = aqua_sf, metric_name = "tos", colname = "slpTrends", metric_df = ensemble[[5]], PUs = PUs)

features <- aqua_percentile %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_percentile, `tos_NorESM2-MM`, cost)
s18 <- readRDS("../Output/solutions/s18-percentile-tos-585-NorESM2-MM-ensemble.rds")
```
```{r}
p18 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.8) %>% # using Effective 40% Protection. Since we only retained planning units that intersect with both biodiversity features and areas >= 50th percentile (0.5), by multiplying this by 0.8 target, we effectively protect only 40%.
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
```{r eval = FALSE}
s18 <- prioritizr::solve(p18)
```
```{r include = FALSE}
s18_plot <- s18 %>% 
  mutate(solution_1 = as.logical(solution_1)) 
(ggSol18 <- fSpatPlan_PlotSolution(s18_plot, PUs, land) + ggtitle("Climate-smart design: Rate of Climate Warming", subtitle = "Percentile, SSP 5-8.5 (GCM: NorESM2-MM)"))
```

## Showing variability
```{r include = FALSE}
solution_list <- list(s14, s15, s16, s17, s18)
col_names <- c("tos_CanESM5", "tos_CMCC-ESM2", "tos_GFDL-ESM4", "tos_IPSL-CM6A-LR", "tos_NorESM2-MM")
Selection_Ensemble_Frequency <- create_LowRegretSf(solution_list, col_names, PUs)
```
```{r echo = FALSE}
(gg_Selection_Ensemble_Frequency <- plot_lowregret(Selection_Ensemble_Frequency, land) + labs(subtitle = "Variability in GCMs"))
```

```{r include = FALSE}
list <- c("CanESM5", "CMCC-ESM2", "GFDL-ESM4", "IPSL-CM6A-LR", "NorESM2-MM")
object_list <- list() # empty list
solution_list <- list(s14, s15, s16, s17, s18)
for (i in 1:length(list)) {
  obj <- select_solution(solution_list[[i]], list[i])
  object_list[[i]] <- obj
}
```
```{r echo = FALSE}
(matrix <- create_corrmatrix(object_list) %>% 
    plot_corrplot(., length(object_list)))
```