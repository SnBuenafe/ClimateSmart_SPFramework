# Research Question #1 {#rq-1}

__How much more would a climate-smart spatial design cost, compared to a climate-uninformed spatial design?__

To answer this question, we create a climate-uninformed spatial design. As the name suggests, it does not involve any climate layer in its design. It only utilizes the [AquaMaps Layers](#conservation-features) and [cost layer](#cost-layer). The runs here show only those forced under SSP 5-8.5. Then, we compare it with a climate-smart spatial design. This design utilizes the same layers as the climate-uninformed design, with the addition of [climate layers](#climate-metrics) Here, we chose to use _rate of climate warming_ as the climate layer. Hence, __climate refugia__ (i.e. areas of low exposure) are defined as areas that have magnitudes of climate warming $\leq$ median climate warming.

For this comparison, we chose to use the __"percentile" approach__, one of the three climate-smart approaches explored in this study. The two other approaches are detailed in the subsequent sections. In this approach, we incorporate the climate metric (i.e. rate of climate warming) into the spatial design as a "filtering metric" for the biodiversity/conservation features (i.e. AquaMaps species distribution maps). By this, I mean, we only retain the planning units of each specific feature if it coincides with its species' climate refugia (i.e. planning unit has a climate warming value $\leq$ median climate warming of the feature). By doing so, we ensure that we only protect climate refugia if they have any biodiversity value.

## Climate-uninformed spatial design

```{r include = FALSE}
# set working directory:
setwd("/Users/tinbuenafe/GitHub/SpatialPlanning/")

# List of features
features <- aqua_sf %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_sf, cost)
```
We set up the climate-uninformed spatial planning problem:
```{r}
p1 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.4) %>% # using 40% as the target percentage of protection
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
And we solve it:
```{r}
s1 <- prioritizr::solve(p1)
```
```{r echo = FALSE}
s1_plot <- s1 %>% 
  mutate(solution_1 = as.logical(solution_1)) 
(ggSol1 <- fSpatPlan_PlotSolution(s1_plot, PUs, land) + ggtitle("Uninformed"))

```
```{r include = FALSE}
## Get the summary
# Feature representation
feat_rep <- represent_feature(p1, s1, "uninformed")
total_area = nrow(PUs) * PU_size
# Summary
summary <- compute_summary(s1, total_area, PU_size, "uninformed", Cost = "Cost_squish")
```

## Climate-smart spatial design (Rate of Climate Warming; "Percentile" Approach)
```{r include = FALSE}
# Create climate-layer
aqua_percentile <- create_PercentileLayer(aqua_sf = aqua_sf, metric_name = "tos", colname = "slpTrends", metric_df = roc_tos_SSP585, PUs = PUs)

# List of features
features <- aqua_percentile %>% 
  as_tibble() %>% 
  dplyr::select(-geometry) %>% 
  names()

out_sf <- cbind(aqua_percentile, roc_tos_SSP585, cost)
```
We set up the climate-smart spatial planning problem:
```{r}
p2 <- prioritizr::problem(out_sf, features, "Cost_squish") %>%
  add_min_set_objective() %>%
  add_relative_targets(0.8) %>% # using Effective 40% Protection. Since we only retained planning units that intersect with both biodiversity features and areas <= 50th percentile (0.5), by multiplying this by 0.8 target, we effectively protect only 40%.
  add_binary_decisions() %>%
  add_gurobi_solver(gap = 0, verbose = FALSE)
```
And we solve it:
```{r}
s2 <- prioritizr::solve(p2)
```
```{r echo = FALSE}
s2_plot <- s2 %>% 
  mutate(solution_1 = as.logical(solution_1))
(ggSol2 <- fSpatPlan_PlotSolution(s2_plot, PUs, land) + ggtitle("Climate-smart design: Rate of Climate Warming", subtitle = "Percentile, SSP 5-8.5"))
```
```{r include = FALSE}
## Get summary
# Feature representation
temp <- represent_feature(p2, s2, "percentile_tos_585")
feat_rep <- left_join(temp, feat_rep)
# Summary
temp <- compute_summary(s2, total_area, PU_size, "percentile_tos_585", Cost = "Cost_squish")
summary <- rbind(temp, summary)
df <- s1 %>% as_tibble() %>% 
  dplyr::select(solution_1, geometry) %>% 
  left_join(., roc_tos_SSP585) %>% 
  filter(solution_1 == 1) %>% 
  summarize(mean_climate_warming = mean(slpTrends),
            mean_log_climate_warming = mean(log(slpTrends))) %>% 
  dplyr::mutate(run = "uninformed")

# Get the mean rate of climate warming for climate-smart design
df1 <- s2 %>% as_tibble() %>% 
  dplyr::select(solution_1, geometry, slpTrends) %>% 
  filter(solution_1 == 1) %>% 
  summarize(mean_climate_warming = mean(slpTrends),
            mean_log_climate_warming = mean(log(slpTrends))) %>% 
  dplyr::mutate(run = "percentile_tos_585") %>% 
  add_row(df, .)

summary <- summary %>% left_join(., df1, by = c("run"))
```

## Climate-uninformed versus Climate-smart spatial designs
We now compare the two designs.

Total cost and percent area selected for protection:
```{r include = FALSE}
ggSummary_Cost <- plot_statistics1(summary, col_name = "log10(total_cost)", y_axis = "log10(cost)")
ggSummary_Area <- plot_statistics1(summary, col_name = "percent_area", y_axis = "% area")
```
```{r}
ggSummary_Cost + ggSummary_Area
```
```{r include = FALSE}
ggSummary_Warming <- plot_statistics1(summary, col_name = "mean_climate_warming", y_axis = expression('Δ'^"o"*'C yr'^"-1"*''))
ggSummary_LogWarming <- plot_statistics1(summary, col_name = "mean_log_climate_warming", y_axis = expression('log Δ'^"o"*'C yr'^"-1"*'')) + scale_y_reverse()
```
```{r}
ggSummary_Warming + ggSummary_LogWarming
```

Cohen's Kappa Correlation Matrix:
```{r include = FALSE}
list <- c("uninformed", "percentile_tos_585")
object_list <- list() # empty list
solution_list <- list(s1, s2)
for (i in 1:length(list)) {
  obj <- select_solution(solution_list[[i]], list[i])
  object_list[[i]] <- obj
}
```
```{r message = FALSE, echo = FALSE}
(matrix <- create_corrmatrix(object_list) %>% 
    plot_corrplot(., length(object_list)))
```
